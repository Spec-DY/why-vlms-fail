<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>国际象棋棋盘编辑器</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        background: #f5f5f5;
        margin: 0;
      }

      h1 {
        color: #333;
        margin-bottom: 20px;
      }

      .piece-selector {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .piece-selector h2 {
        margin-top: 0;
        color: #666;
        font-size: 18px;
      }

      .pieces-grid {
        display: grid;
        grid-template-columns: repeat(7, 60px);
        gap: 10px;
        margin-bottom: 10px;
      }

      .piece-btn {
        width: 60px;
        height: 60px;
        border: 2px solid #ddd;
        border-radius: 5px;
        cursor: pointer;
        background: white;
        padding: 5px;
        transition: all 0.2s;
      }

      .piece-btn:hover {
        border-color: #999;
        transform: scale(1.05);
      }

      .piece-btn.selected {
        border-color: #4caf50;
        background: #e8f5e9;
        transform: scale(1.1);
      }

      .piece-btn img {
        width: 100%;
        height: 100%;
      }

      .eraser-btn {
        font-size: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .board-container {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .board-wrapper {
        display: inline-grid;
        grid-template-columns: repeat(8, 100px);
        grid-template-rows: repeat(8, 100px);
        border: 4px solid #333;
      }

      .square {
        width: 100px;
        height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: opacity 0.2s;
        position: relative;
      }

      .square:hover {
        opacity: 0.8;
      }

      .square.light {
        background-color: #f0d9b5;
      }

      .square.dark {
        background-color: #b58863;
      }

      .square img {
        width: 100px;
        height: 100px;
        pointer-events: none;
      }

      .rank-label {
        position: absolute;
        top: 1px;
        left: 4px;
        font-weight: bold;
        font-size: 24px;
        pointer-events: none;
      }

      .file-label {
        position: absolute;
        bottom: 1px;
        right: 4px;
        font-weight: bold;
        font-size: 24px;
        pointer-events: none;
      }

      .square.light .rank-label,
      .square.light .file-label {
        color: #b58863;
      }

      .square.dark .rank-label,
      .square.dark .file-label {
        color: #f0d9b5;
      }

      .buttons {
        display: flex;
        gap: 15px;
      }

      button {
        padding: 12px 24px;
        font-size: 16px;
        font-weight: bold;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .clear-btn {
        background: #f44336;
        color: white;
      }

      .clear-btn:hover {
        background: #d32f2f;
      }

      .download-btn {
        background: #4caf50;
        color: white;
      }

      .download-btn:hover {
        background: #45a049;
      }
    </style>
  </head>
  <body>
    <h1>国际象棋棋盘编辑器</h1>

    <div class="piece-selector">
      <h2>选择棋子</h2>
      <div class="pieces-grid" id="piecesGrid"></div>
    </div>

    <div class="board-container">
      <div class="board-wrapper" id="boardWrapper"></div>
    </div>

    <div class="buttons">
      <button class="clear-btn" onclick="clearBoard()">清空棋盘</button>
      <button class="download-btn" onclick="downloadBoard()">下载为图片</button>
    </div>

    <canvas id="canvas" style="display: none"></canvas>

    <script>
      const pieces = [
        { name: "bp", label: "黑兵" },
        { name: "bn", label: "黑马" },
        { name: "bb", label: "黑象" },
        { name: "br", label: "黑车" },
        { name: "bq", label: "黑后" },
        { name: "bk", label: "黑王" },
        { name: "wp", label: "白兵" },
        { name: "wn", label: "白马" },
        { name: "wb", label: "白象" },
        { name: "wr", label: "白车" },
        { name: "wq", label: "白后" },
        { name: "wk", label: "白王" },
      ];

      let board = Array(8)
        .fill(null)
        .map(() => Array(8).fill(null));
      let selectedPiece = null;

      // 初始化棋子选择器
      function initializePieceSelector() {
        const grid = document.getElementById("piecesGrid");

        pieces.forEach((piece) => {
          const btn = document.createElement("button");
          btn.className = "piece-btn";
          btn.title = piece.label;
          btn.onclick = () => selectPiece(piece.name, btn);

          const img = document.createElement("img");
          img.src = `${piece.name}.png`;
          img.alt = piece.label;
          btn.appendChild(img);

          grid.appendChild(btn);
        });

        // 添加橡皮擦
        const eraserBtn = document.createElement("button");
        eraserBtn.className = "piece-btn eraser-btn";
        eraserBtn.title = "橡皮擦";
        eraserBtn.textContent = "🧹";
        eraserBtn.onclick = () => selectPiece("eraser", eraserBtn);
        grid.appendChild(eraserBtn);
      }

      // 选择棋子
      function selectPiece(pieceName, btnElement) {
        document.querySelectorAll(".piece-btn").forEach((btn) => {
          btn.classList.remove("selected");
        });
        btnElement.classList.add("selected");
        selectedPiece = pieceName;
      }

      // 初始化棋盘
      function initializeBoard() {
        const boardWrapper = document.getElementById("boardWrapper");
        const files = ["a", "b", "c", "d", "e", "f", "g", "h"];
        const ranks = ["8", "7", "6", "5", "4", "3", "2", "1"];

        for (let row = 0; row < 8; row++) {
          for (let col = 0; col < 8; col++) {
            const square = document.createElement("div");
            square.className = `square ${
              (row + col) % 2 === 0 ? "light" : "dark"
            }`;
            square.dataset.row = row;
            square.dataset.col = col;
            square.onclick = () => handleSquareClick(row, col);

            // 添加行号标签（左侧第一列）
            if (col === 0) {
              const rankLabel = document.createElement("div");
              rankLabel.className = "rank-label";
              rankLabel.textContent = ranks[row];
              square.appendChild(rankLabel);
            }

            // 添加列号标签（底部最后一行）
            if (row === 7) {
              const fileLabel = document.createElement("div");
              fileLabel.className = "file-label";
              fileLabel.textContent = files[col];
              square.appendChild(fileLabel);
            }

            boardWrapper.appendChild(square);
          }
        }
      }

      // 处理格子点击
      function handleSquareClick(row, col) {
        if (selectedPiece === "eraser") {
          board[row][col] = null;
        } else if (selectedPiece) {
          board[row][col] = selectedPiece;
        }
        updateBoard();
      }

      // 更新棋盘显示
      function updateBoard() {
        const boardWrapper = document.getElementById("boardWrapper");
        const squares = boardWrapper.querySelectorAll(".square");
        squares.forEach((square) => {
          const row = parseInt(square.dataset.row);
          const col = parseInt(square.dataset.col);
          const piece = board[row][col];

          // 移除旧的棋子图片（保留标签）
          const oldImg = square.querySelector("img");
          if (oldImg) {
            oldImg.remove();
          }

          // 添加新棋子
          if (piece) {
            const img = document.createElement("img");
            img.src = `${piece}.png`;
            img.alt = piece;
            square.appendChild(img);
          }
        });
      }

      // 清空棋盘
      function clearBoard() {
        board = Array(8)
          .fill(null)
          .map(() => Array(8).fill(null));
        updateBoard();
      }

      // 下载棋盘为图片
      async function downloadBoard() {
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");

        canvas.width = 800;
        canvas.height = 800;

        const files = ["a", "b", "c", "d", "e", "f", "g", "h"];
        const ranks = ["8", "7", "6", "5", "4", "3", "2", "1"];

        // 创建一个Promise数组来等待所有图片加载
        const imagePromises = [];

        // 绘制棋盘
        for (let row = 0; row < 8; row++) {
          for (let col = 0; col < 8; col++) {
            const isLight = (row + col) % 2 === 0;
            ctx.fillStyle = isLight ? "#F0D9B5" : "#B58863";
            ctx.fillRect(col * 100, row * 100, 100, 100);

            // 绘制标签
            ctx.font = "bold 24px Arial";
            ctx.fillStyle = isLight ? "#B58863" : "#F0D9B5";

            // 左侧列显示行号
            if (col === 0) {
              ctx.fillText(ranks[row], col * 100 + 4, row * 100 + 18);
            }

            // 底部行显示列号
            if (row === 7) {
              ctx.textAlign = "right";
              ctx.fillText(
                files[col],
                (col + 1) * 100 - 4,
                (row + 1) * 100 - 3
              );
              ctx.textAlign = "left";
            }

            // 绘制棋子
            if (board[row][col]) {
              const img = new Image();
              img.src = `${board[row][col]}.png`;

              const promise = new Promise((resolve) => {
                img.onload = () => {
                  ctx.drawImage(img, col * 100, row * 100, 100, 100);
                  resolve();
                };
                img.onerror = () => {
                  console.error(`Failed to load ${board[row][col]}.png`);
                  resolve();
                };
              });

              imagePromises.push(promise);
            }
          }
        }

        // 等待所有图片加载完成
        await Promise.all(imagePromises);

        // 下载图片
        canvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "chess-board.png";
          a.click();
          URL.revokeObjectURL(url);
        });
      }

      // 初始化
      initializeBoard();
      initializePieceSelector();
    </script>
  </body>
</html>
